<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>educe - 2D Metroidvania</title>
  <script src="https://game-cdn.poki.com/scripts/v2/poki-sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body,
    html {
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-y: auto;
      position: relative;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    #app {
      width: 100%;
      max-width: 1400px;
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: center;
      gap: 20px;
      padding: 20px;
    }

    #game-container {
      display: flex;
      justify-content: center;
      flex: 0 0 auto;
      position: relative;
    }

    canvas {
      display: block;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      background-color: #000;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    #editor-container {
      flex: 1 1 400px;
      max-width: 600px;
      min-width: 300px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid #222;
      border-radius: 6px;
      color: #fff;
      font-family: monospace;
      height: fit-content;
      max-height: 90vh;
      overflow-y: auto;
    }

    #editor-ui {
      display: none;
      pointer-events: auto;
    }

    #editor-selection-overlay,
    #editor-preview-overlay {
      position: absolute;
      border: 2px solid rgba(0, 255, 255, 0.6);
      background: rgba(0, 255, 255, 0.18);
      pointer-events: none;
      display: none;
      box-sizing: border-box;
      z-index: 2;
    }

    #editor-preview-overlay {
      border: 2px dashed rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.1);
      z-index: 3;
    }

    .palette-root {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .palette-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .palette-grid[data-active="false"] {
      opacity: 0.55;
    }

    .palette-item {
      position: relative;
      border: 1px solid rgba(80, 80, 80, 0.8);
      background: rgba(15, 15, 15, 0.9);
      border-radius: 4px;
      padding: 4px;
      cursor: pointer;
      transition: border 0.15s ease, transform 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      min-height: 40px;
    }

    .palette-item:hover {
      border-color: rgba(120, 120, 120, 0.9);
      transform: translateY(-1px);
    }

    .palette-item.is-selected {
      border-color: rgba(100, 170, 255, 0.95);
      box-shadow: 0 0 4px rgba(100, 170, 255, 0.6);
    }

    .palette-item canvas,
    .palette-item img {
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      display: block;
    }

    .palette-item-label {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.7);
    }

    #debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      color: white;
      font-family: monospace;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px;
      border-radius: 4px;
      z-index: 1000;
      pointer-events: none;
      display: none;
    }

    #game-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-family: monospace;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.9);
      padding: 30px;
      border-radius: 8px;
      z-index: 2000;
      text-align: center;
      border: 2px solid #444;
    }

    #game-menu h2 {
      margin-bottom: 20px;
      font-size: 24px;
      color: #4CAF50;
    }

    #game-menu button {
      display: block;
      width: 200px;
      margin: 8px auto;
      padding: 10px 16px;
      background: rgba(76, 175, 80, 0.8);
      color: white;
      border: 2px solid #4CAF50;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
    }

    #game-menu button:hover {
      background: #4CAF50;
      transform: scale(1.05);
    }

    #audio-controls {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #444;
    }

    #audio-controls>div {
      margin: 10px 0;
    }

    #audio-controls input[type="range"] {
      width: 150px;
      margin: 0 10px;
    }

    #audio-controls button {
      width: auto;
      display: inline-block;
      margin: 4px;
      padding: 6px 12px;
      font-size: 12px;
    }

    #touch-controls {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 24px;
      display: none;
      justify-content: space-between;
      align-items: center;
      padding: 0 32px;
      z-index: 1500;
      pointer-events: none;
    }

    .touch-controls__cluster {
      display: flex;
      gap: 20px;
      pointer-events: auto;
    }

    .touch-button {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.35);
      background: rgba(30, 30, 30, 0.65);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: monospace;
      font-size: 20px;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      -webkit-touch-callout: none;
      transition: transform 0.12s ease, border 0.12s ease, background 0.12s ease, color 0.12s ease;
      pointer-events: auto;
    }

    .touch-button:active {
      transform: scale(0.96);
    }

    .touch-button.is-active {
      background: rgba(76, 175, 80, 0.7);
      border-color: rgba(76, 175, 80, 0.9);
      color: #e8ffe8;
      transform: scale(1.04);
    }

    .touch-button[data-action="jump"] {
      border-color: rgba(86, 149, 255, 0.8);
    }

    .touch-button[data-action="jump"].is-active {
      background: rgba(86, 149, 255, 0.7);
      border-color: rgba(86, 149, 255, 1);
    }

    .touch-button[data-action="unmerge"] {
      border-color: rgba(255, 193, 7, 0.8);
    }

    .touch-button[data-action="unmerge"].is-active {
      background: rgba(255, 193, 7, 0.7);
      border-color: rgba(255, 193, 7, 1);
      color: #1b1300;
    }

    #victory-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: transparent;
      z-index: 2500;
    }

    #victory-overlay.is-visible {
      display: flex;
    }

    .victory-modal {
      min-width: 280px;
      max-width: 520px;
      padding: 36px 42px;
      border-radius: 10px;
      border: 2px solid rgba(76, 175, 80, 0.9);
      background: rgba(12, 12, 12, 0.95);
      color: #f2fff2;
      text-align: center;
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.45);
      font-family: monospace;
    }

    .victory-modal h2 {
      font-size: 28px;
      margin-bottom: 18px;
      color: #7CFF8A;
      letter-spacing: 1px;
    }

    .victory-modal p {
      font-size: 16px;
      margin-bottom: 24px;
      color: #d0ffd6;
      line-height: 1.5;
    }

    .victory-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .victory-actions button {
      padding: 12px 18px;
      font-size: 16px;
      border: 2px solid rgba(76, 175, 80, 0.9);
      border-radius: 6px;
      background: rgba(76, 175, 80, 0.82);
      color: #0d2b11;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
      transition: transform 0.15s ease, background 0.15s ease, border 0.15s ease;
    }

    .victory-actions button:hover:not(:disabled) {
      transform: translateY(-2px);
      background: rgba(109, 209, 112, 0.9);
    }

    .victory-actions button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      background: rgba(60, 60, 60, 0.7);
      border-color: rgba(90, 90, 90, 0.8);
      color: rgba(220, 220, 220, 0.6);
    }

    @media (max-width: 720px) {
      #touch-controls {
        padding: 0 16px;
        bottom: 16px;
      }

      .touch-button {
        width: 56px;
        height: 56px;
        font-size: 18px;
      }

      .victory-modal {
        width: calc(100% - 48px);
        padding: 30px 24px;
      }
    }

    /* Help Overlay */
    #help-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      z-index: 3000;
      padding: 20px;
    }

    #help-overlay.is-visible {
      display: flex;
    }

    .help-modal {
      position: relative;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 32px 36px;
      border-radius: 10px;
      border: 2px solid rgba(76, 175, 80, 0.9);
      background: rgba(12, 12, 12, 0.98);
      color: #f2fff2;
      font-family: monospace;
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.6);
    }

    .help-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 32px;
      line-height: 1;
      cursor: pointer;
      padding: 4px 8px;
      transition: color 0.2s ease, transform 0.15s ease;
    }

    .help-close:hover {
      color: #fff;
      transform: scale(1.1);
    }

    .help-modal h2 {
      font-size: 28px;
      margin: 0 0 24px 0;
      color: #7CFF8A;
      letter-spacing: 1px;
      text-align: center;
    }

    .help-modal h3 {
      font-size: 20px;
      margin: 0 0 12px 0;
      color: #9FE6A7;
      letter-spacing: 0.5px;
    }

    .help-sections {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .help-section {
      padding: 16px;
      background: rgba(20, 20, 20, 0.6);
      border-radius: 8px;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .help-section p {
      margin: 8px 0;
      line-height: 1.6;
      color: #d0ffd6;
      font-size: 14px;
    }

    .help-tip {
      margin-top: 12px;
      padding: 8px 12px;
      background: rgba(76, 175, 80, 0.15);
      border-left: 3px solid rgba(76, 175, 80, 0.8);
      border-radius: 4px;
      font-style: italic;
      color: #b8ffbd;
    }

    .help-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .help-control-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      background: rgba(30, 30, 30, 0.5);
      border-radius: 6px;
    }

    .help-control-item kbd {
      display: inline-block;
      min-width: 32px;
      padding: 6px 10px;
      background: linear-gradient(180deg, #505050 0%, #353535 100%);
      border: 2px solid #666;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      color: #fff;
      font-family: monospace;
      font-size: 13px;
      font-weight: bold;
      text-align: center;
      line-height: 1;
    }

    .help-control-item span {
      flex: 1;
      color: #d0ffd6;
      font-size: 14px;
    }

    #help-button {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: 2px solid rgba(76, 175, 80, 0.8);
      background: rgba(20, 20, 20, 0.85);
      color: #7CFF8A;
      font-family: monospace;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
    }

    #help-button:hover {
      background: rgba(76, 175, 80, 0.9);
      color: #0d2b11;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    @media (max-width: 720px) {
      .help-modal {
        max-width: calc(100% - 32px);
        padding: 24px 20px;
      }

      .help-modal h2 {
        font-size: 24px;
      }

      .help-modal h3 {
        font-size: 18px;
      }

      .help-control-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      #help-button {
        width: 36px;
        height: 36px;
        font-size: 20px;
        top: 12px;
        right: 12px;
      }
    }

    /* Tutorial Overlay System */
    #tutorial-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tutorial-prompt {
      position: absolute;
      background: rgba(12, 12, 12, 0.95);
      border: 3px solid rgba(76, 175, 80, 0.9);
      border-radius: 12px;
      padding: 24px 32px;
      color: #f2fff2;
      font-family: monospace;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7), 0 0 20px rgba(76, 175, 80, 0.3);
      animation: tutorialPulse 2s ease-in-out infinite;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .tutorial-prompt.is-visible {
      opacity: 1;
      transform: scale(1);
    }

    .tutorial-prompt h3 {
      font-size: 22px;
      margin: 0 0 16px 0;
      color: #7CFF8A;
      letter-spacing: 0.5px;
      text-align: center;
    }

    .tutorial-keys {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: center;
      margin-bottom: 12px;
    }

    .tutorial-keys kbd {
      display: inline-block;
      min-width: 48px;
      padding: 12px 16px;
      background: linear-gradient(180deg, #505050 0%, #353535 100%);
      border: 3px solid #666;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.15);
      color: #fff;
      font-family: monospace;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      line-height: 1;
    }

    .tutorial-description {
      text-align: center;
      font-size: 16px;
      color: #d0ffd6;
      margin-top: 8px;
    }

    @keyframes tutorialPulse {

      0%,
      100% {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7), 0 0 20px rgba(76, 175, 80, 0.3);
      }

      50% {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.7), 0 0 30px rgba(76, 175, 80, 0.6);
      }
    }

    @media (max-width: 720px) {
      .tutorial-prompt {
        padding: 20px 24px;
        max-width: calc(100% - 48px);
      }

      .tutorial-prompt h3 {
        font-size: 18px;
        margin-bottom: 12px;
      }

      .tutorial-keys kbd {
        min-width: 40px;
        padding: 10px 12px;
        font-size: 18px;
      }

      .tutorial-description {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="game-container">
      <canvas id="screen"></canvas>
    </div>
  </div>

  <div id="debug-info">
    <div id="debug-text"></div>
  </div>

  <div id="game-menu">
    <h2>EDUCE</h2>
    <button id="resume-btn">Resume Game</button>
    <button id="rewarded-ad-btn">Watch Ad for Bonus</button>
    <button id="share-game-btn">Share Game</button>
    <div id="audio-controls">
      <div><strong>Audio Controls</strong></div>
      <div>
        <button id="play-midi">‚ñ∂ Play Music</button>
        <button id="stop-midi">‚è∏ Stop Music</button>
      </div>
      <div>
        BGM Volume:
        <button id="bgm-vol-down">-</button>
        <input id="bgm-volume" type="range" min="0" max="100" value="30" />
        <button id="bgm-vol-up">+</button>
      </div>
      <div id="bgm-volume-display">BGM: 30%</div>
      <div>
        SFX Volume:
        <button id="sfx-vol-down">-</button>
        <input id="sfx-volume" type="range" min="0" max="100" value="50" />
        <button id="sfx-vol-up">+</button>
      </div>
      <div id="sfx-volume-display">SFX: 50%</div>
    </div>
  </div>

  <div id="victory-overlay" aria-hidden="true">
    <div class="victory-modal" role="dialog" aria-labelledby="victory-title" aria-describedby="victory-summary">
      <h2 id="victory-title">Level Complete</h2>
      <p id="victory-summary">Great work!</p>
      <div class="victory-actions">
        <button id="victory-next-btn">Next Level</button>
        <button id="victory-restart-btn">Restart Level</button>
      </div>
    </div>
  </div>

  <div id="help-overlay">
    <div class="help-modal">
      <button id="help-close-btn" class="help-close" aria-label="Close Help">&times;</button>
      <h2>How to Play</h2>
      <div class="help-sections">
        <div class="help-section">
          <h3>üéÆ Movement</h3>
          <div class="help-controls">
            <div class="help-control-item">
              <kbd>A</kbd> <kbd>D</kbd>
              <span>Move Left/Right</span>
            </div>
            <div class="help-control-item">
              <kbd>W</kbd> <kbd>Space</kbd>
              <span>Jump</span>
            </div>
          </div>
        </div>

        <div class="help-section">
          <h3>üß¨ Merge & Evolve</h3>
          <p>Walk into NPCs (creatures) to <strong>merge</strong> with them and evolve into new forms!</p>
          <p>Each form has unique abilities to help you navigate the world.</p>
        </div>

        <div class="help-section">
          <h3>‚Ü©Ô∏è Unmerge</h3>
          <div class="help-controls">
            <div class="help-control-item">
              <kbd>S</kbd>
              <span>Unmerge - Split off and leave behind your previous form</span>
            </div>
          </div>
          <p class="help-tip">Use unmerge strategically to access different areas!</p>
        </div>

        <div class="help-section">
          <h3>üéØ Objective</h3>
          <p>Reach the <strong>exit tile</strong> to complete each level.</p>
        </div>
      </div>
    </div>
  </div>

  <button id="help-button" aria-label="Show Help">?</button>

  <div id="tutorial-overlay">
    <div id="tutorial-movement" class="tutorial-prompt">
      <h3>Movement</h3>
      <div class="tutorial-keys">
        <kbd>A</kbd>
        <kbd>D</kbd>
      </div>
      <div class="tutorial-description">Move Left and Right</div>
    </div>
  </div>
  <div id="tutorial-merge" class="tutorial-prompt">
    <h3>Merge</h3>
    <div class="tutorial-description">Walk into creatures to Merge</div>
  </div>
  <div id="tutorial-unmerge" class="tutorial-prompt">
    <h3>Unmerge</h3>
    <div class="tutorial-keys">
      <kbd>S</kbd>
    </div>
    <div class="tutorial-description">Press to Split</div>
  </div>
  <div id="tutorial-jump" class="tutorial-prompt">
    <h3>Jump</h3>
    <div class="tutorial-keys">
      <kbd>W</kbd>
      <span style="color: #9FE6A7;">or</span>
      <kbd>Space</kbd>
    </div>
    <div class="tutorial-description">Press to Jump</div>
  </div>
  <div id="tutorial-exit" class="tutorial-prompt">
    <h3>Goal</h3>
    <div class="tutorial-description">Reach the Checkmark to Win!</div>
  </div>
  </div>

  <div id="touch-controls">
    <div class="touch-controls__cluster touch-controls__cluster--movement">
      <button class="touch-button" data-action="moveLeft" aria-label="Move Left">&lt;</button>
      <button class="touch-button" data-action="moveRight" aria-label="Move Right">&gt;</button>
    </div>
    <div class="touch-controls__cluster touch-controls__cluster--actions">
      <button class="touch-button" data-action="jump" aria-label="Jump">J</button>
      <button class="touch-button" data-action="unmerge" aria-label="Unmerge">U</button>
    </div>
  </div>

  <script>
    const isLocalDev = ['localhost', '127.0.0.1', ''].includes(location.hostname);
    const defaultRuntimeConfig = {
      devTools: isLocalDev,
      hotReload: isLocalDev,
    };
    window.RUNTIME_CONFIG = Object.assign({}, defaultRuntimeConfig, window.RUNTIME_CONFIG || {});

    if (window.RUNTIME_CONFIG.devTools) {
      const gameContainer = document.getElementById('game-container');
      if (gameContainer) {
        const selectionOverlay = document.createElement('div');
        selectionOverlay.id = 'editor-selection-overlay';
        gameContainer.appendChild(selectionOverlay);

        const previewOverlay = document.createElement('div');
        previewOverlay.id = 'editor-preview-overlay';
        gameContainer.appendChild(previewOverlay);
      }

      const appRoot = document.getElementById('app');
      if (appRoot) {
        const editorUI = document.createElement('div');
        editorUI.id = 'editor-ui';
        editorUI.style.display = 'block';

        const editorContainer = document.createElement('div');
        editorContainer.id = 'editor-container';

        const paletteRoot = document.createElement('div');
        paletteRoot.id = 'palette-root';
        paletteRoot.className = 'palette-root';

        editorContainer.appendChild(paletteRoot);
        editorUI.appendChild(editorContainer);
        appRoot.appendChild(editorUI);
      }
    }
  </script>
  <script type="module" src="src/game/main.js"></script>
</body>

</html>